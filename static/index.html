<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <title>Kuack Agent</title>
  <style>
    :root {
      --bg-color: #0b0d12;
      --bg-secondary: #161b22;
      --text-primary: #e6edf3;
      --text-secondary: #9ea7b0;
      --accent-color: #58a6ff;
      --accent-hover: #3391ff;
      --border-color: #30363d;
      --font-main: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
      --font-mono: "JetBrains Mono", monospace;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-main);
      background-color: var(--bg-color);
      color: var(--text-primary);
      line-height: 1.6;
      margin: 0;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 30px auto;
      background: var(--bg-secondary);
      padding: 30px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    h1 {
      color: var(--text-primary);
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 24px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 15px;
    }

    .status {
      padding: 15px;
      margin: 20px 0;
      border-radius: 6px;
      font-weight: 500;
      border: 1px solid transparent;
      display: flex;
      align-items: center;
    }

    .status::before {
      content: "";
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 10px;
    }

    .status.disconnected {
      background: rgba(248, 81, 73, 0.1);
      color: #ff7b72;
      border-color: rgba(248, 81, 73, 0.4);
    }

    .status.disconnected::before {
      background-color: #ff7b72;
    }

    .status.connecting {
      background: rgba(210, 153, 34, 0.1);
      color: #d29922;
      border-color: rgba(210, 153, 34, 0.4);
    }

    .status.connecting::before {
      background-color: #d29922;
    }

    .status.connected {
      background: rgba(63, 185, 80, 0.1);
      color: #3fb950;
      border-color: rgba(63, 185, 80, 0.4);
    }

    .status.connected::before {
      background-color: #3fb950;
    }

    button {
      background: var(--accent-color);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      margin-right: 10px;
      transition: background-color 0.2s;
    }

    button:hover {
      background: var(--accent-hover);
    }

    button:disabled {
      background: var(--border-color);
      color: var(--text-secondary);
      cursor: not-allowed;
    }

    .info {
      margin: 15px 0;
      font-size: 14px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
    }

    .info label {
      font-weight: 600;
      width: 140px;
      color: var(--text-primary);
      flex-shrink: 0;
    }

    .info span {
      font-family: var(--font-mono);
      color: var(--text-primary);
    }

    input {
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      width: 100%;
      max-width: 400px;
      font-size: 14px;
      background: var(--bg-color);
      color: var(--text-primary);
      font-family: var(--font-mono);
    }

    input:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.3);
    }

    .warning {
      background: rgba(210, 153, 34, 0.1);
      border: 1px solid rgba(210, 153, 34, 0.4);
      padding: 15px;
      border-radius: 6px;
      margin: 20px 0;
      color: #e3b341;
      font-size: 14px;
    }

    .logs-container {
      margin-top: 30px;
    }

    .logs-header {
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--text-primary);
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #logs {
      background: #0d1117;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 15px;
      height: 300px;
      overflow-y: auto;
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--text-secondary);
      white-space: pre-wrap;
    }

    #logs div {
      margin-bottom: 4px;
      border-bottom: 1px solid rgba(48, 54, 61, 0.3);
      padding-bottom: 4px;
      word-break: break-all;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      cursor: pointer;
      margin-left: 10px;
      color: var(--text-secondary);
      font-size: 13px;
    }

    .checkbox-label input {
      width: auto;
      margin-right: 6px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Kuack Agent</h1>

    <div class="warning">
      <strong>Resource Usage Notice</strong><br>
      This page will use your browser's CPU and memory to execute distributed workloads.
      By connecting, you consent to sharing these resources.
    </div>

    <div class="info">
      <label>Server URL:</label>
      <input type="text" id="serverUrl" value="http://localhost:8081" placeholder="http://localhost:8081" />
    </div>

    <div class="info">
      <label>Agent Token:</label>
      <input type="password" id="agentToken" placeholder="Agent Token" value="kuack-demo-token" />
      <label class="checkbox-label">
        <input type="checkbox" id="showPassword" />
        Show
      </label>
    </div>

    <div style="margin-top: 20px; margin-bottom: 20px;">
      <button id="connectBtn">Connect</button>
      <button id="disconnectBtn" disabled>Disconnect</button>
    </div>

    <div id="status" class="status disconnected">
      Status: Disconnected
    </div>

    <div class="info">
      <label>Agent UUID:</label>
      <span id="uuid">-</span>
    </div>

    <div class="info">
      <label>Executed Pods:</label>
      <span id="pods">0</span>
    </div>

    <div class="info">
      <label>CPU:</label>
      <span id="cpu">-</span>
    </div>

    <div class="info">
      <label>Memory:</label>
      <span id="memory">-</span>
    </div>

    <div class="info">
      <label>GPU Support:</label>
      <span id="gpu">-</span>
    </div>

    <div class="logs-container">
      <div class="logs-header">
        Execution Logs
        <button id="clearLogsBtn" style="padding: 4px 8px; font-size: 12px; margin: 0;">Clear</button>
      </div>
      <div id="logs"></div>
    </div>
  </div>

  <script type="module">
    import Agent from '../src/main.ts';

    // Intercept console logs
    const logsEl = document.getElementById('logs');
    const originalLog = console.log;
    const originalWarn = console.warn;
    const originalError = console.error;

    function appendLog(type, args) {
      if (!logsEl) return;

      const msg = args.map(a => {
        if (typeof a === 'object') {
          try {
            return JSON.stringify(a);
          } catch (e) {
            return String(a);
          }
        }
        return String(a);
      }).join(' ');

      // Filter out CPU/Memory detection messages
      if (msg.includes('Detected CPU cores') ||
        msg.includes('Detected memory') ||
        msg.includes('Estimated memory')) {
        return;
      }

      const line = document.createElement('div');
      const time = new Date().toLocaleTimeString();
      line.textContent = `[${time}] ${msg}`;

      if (type === 'error') {
        line.style.color = '#ff7b72';
      } else if (type === 'warn') {
        line.style.color = '#d29922';
      }

      logsEl.appendChild(line);
      logsEl.scrollTop = logsEl.scrollHeight;
    }

    console.log = function (...args) {
      originalLog.apply(console, args);
      appendLog('log', args);
    };

    console.warn = function (...args) {
      originalWarn.apply(console, args);
      appendLog('warn', args);
    };

    console.error = function (...args) {
      originalError.apply(console, args);
      appendLog('error', args);
    };



    let agent = null;
    const statusEl = document.getElementById('status');
    const serverUrlInput = document.getElementById('serverUrl');
    const agentTokenInput = document.getElementById('agentToken');

    // Helper to replace element to strip event listeners.
    // This is necessary because HMR/Sync mode (devspace) can re-run this script, accumulating duplicate listeners if not cleared.
    // By replacing the element with a clone, we drop all existing listeners.
    function replaceElement(id) {
      const el = document.getElementById(id);
      const newEl = el.cloneNode(true);
      el.parentNode.replaceChild(newEl, el);
      return newEl;
    }

    const connectBtn = replaceElement('connectBtn');
    const disconnectBtn = replaceElement('disconnectBtn');
    const clearLogsBtn = replaceElement('clearLogsBtn');

    clearLogsBtn.onclick = () => {
      logsEl.innerHTML = '';
    };

    const showPasswordCheckbox = replaceElement('showPassword');

    // Toggle password visibility
    showPasswordCheckbox.onchange = (e) => {
      agentTokenInput.type = e.target.checked ? 'text' : 'password';
    };

    // Helper function to update UI based on connection state
    function updateConnectionState(state) {
      switch (state) {
        case 'connecting':
          statusEl.className = 'status connecting';
          statusEl.textContent = 'Status: Connecting...';
          connectBtn.disabled = true;
          disconnectBtn.disabled = true;
          break;
        case 'connected':
          statusEl.className = 'status connected';
          statusEl.textContent = 'Status: Connected';
          connectBtn.disabled = true;
          disconnectBtn.disabled = false;
          if (agent) {
            const status = agent.getStatus();
            document.getElementById('uuid').textContent = status.uuid;
            // Update resources immediately when connected
            if (status.cpu) {
              const cores = parseInt(status.cpu) / 1000;
              document.getElementById('cpu').textContent = `${cores} cores`;
            }
            if (status.memory) {
              document.getElementById('memory').textContent = status.memory;
            }
            if (status.gpu !== null) {
              document.getElementById('gpu').textContent = status.gpu ? 'Yes (WebGPU)' : 'No';
            }
          }
          break;
        case 'reconnecting':
          statusEl.className = 'status connecting';
          statusEl.textContent = 'Status: Reconnecting...';
          connectBtn.disabled = true;
          disconnectBtn.disabled = false;
          break;
        case 'disconnected':
          statusEl.className = 'status disconnected';
          statusEl.textContent = 'Status: Disconnected';
          connectBtn.disabled = false;
          disconnectBtn.disabled = true;
          document.getElementById('uuid').textContent = '-';
          document.getElementById('pods').textContent = '0';
          document.getElementById('cpu').textContent = '-';
          document.getElementById('memory').textContent = '-';
          document.getElementById('gpu').textContent = '-';
          break;
      }
    }

    connectBtn.onclick = async () => {
      // Prevent multiple clicks or race conditions
      if (connectBtn.disabled) return;

      if (agent) {
        try {
          await agent.stop();
        } catch (e) { console.warn('Error stopping previous agent:', e); }
        agent = null;
      }

      const serverUrl = serverUrlInput.value;
      const token = agentTokenInput.value;
      // Derive registry URL from server URL
      // If ws(s)://, convert to http(s)://; otherwise keep as-is
      let registryUrl = serverUrl;
      if (serverUrl.startsWith('ws:')) {
        registryUrl = serverUrl.replace(/^ws:\/\//, 'http://');
      } else if (serverUrl.startsWith('wss:')) {
        registryUrl = serverUrl.replace(/^wss:\/\//, 'https://');
      }
      // Remove trailing slash if present to avoid double slashes
      registryUrl = registryUrl.replace(/\/+$/, '');
      registryUrl += '/registry';

      updateConnectionState('connecting');

      try {
        agent = new Agent(serverUrl, token, registryUrl);

        // Listen for connection state changes
        agent.onStateChange((state) => {
          updateConnectionState(state);
        });

        await agent.start();

        // Update status periodically for pod count and resources
        const interval = setInterval(() => {
          if (!agent) {
            clearInterval(interval);
            return;
          }
          const status = agent.getStatus();
          // Only update if connected
          if (status.state === 'connected') {
            // Use executedPods instead of runningPods
            document.getElementById('pods').textContent = status.executedPods;

            // Update resources from detected values
            if (status.cpu) {
              // Convert millicores to cores (e.g., "4000m" -> "4 cores")
              const cores = parseInt(status.cpu) / 1000;
              document.getElementById('cpu').textContent = `${cores} cores`;
            }
            if (status.memory) {
              // Memory is already in format like "2.1Gi", just display it
              document.getElementById('memory').textContent = status.memory;
            }
            if (status.gpu !== null) {
              document.getElementById('gpu').textContent = status.gpu ? 'Yes (WebGPU)' : 'No';
            }
          }
        }, 1000);

      } catch (err) {
        console.error('Connection failed:', err);
        updateConnectionState('disconnected');
        const errorMessage = err instanceof Error ? err.message : err?.toString() || 'Unknown error';
        statusEl.textContent = `Status: Error - ${errorMessage}`;
      }
    };

    disconnectBtn.onclick = async () => {
      if (agent) {
        await agent.stop();
        agent = null;
      }
      updateConnectionState('disconnected');
    };

    // Initialize resource display (will be updated when connected)
    document.getElementById('cpu').textContent = '-';
    document.getElementById('memory').textContent = '-';
    document.getElementById('gpu').textContent = '-';
  </script>
</body>

</html>
