<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kuack Agent</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-top: 0;
    }
    .status {
      padding: 15px;
      margin: 20px 0;
      border-radius: 4px;
      font-weight: 500;
    }
    .status.disconnected { background: #fee; color: #c33; }
    .status.connecting { background: #ffc; color: #990; }
    .status.connected { background: #efe; color: #3c3; }
    button {
      background: #0066cc;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
    }
    button:hover { background: #0052a3; }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .info {
      margin: 20px 0;
      font-size: 14px;
      color: #666;
    }
    .info label {
      font-weight: 600;
      display: inline-block;
      width: 120px;
    }
    input {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 400px;
      font-size: 14px;
    }
    .warning {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Kuack Agent</h1>

    <div class="warning">
      <strong>Resource Usage Notice</strong><br>
      This page will use your browser's CPU and memory to execute distributed workloads.
      By connecting, you consent to sharing these resources.
    </div>

    <div class="info">
      <label>Server URL:</label>
      <input type="text" id="serverUrl" value="ws://kuack-node.localhost:8081" />
    </div>

    <div>
      <button id="connectBtn">Connect</button>
      <button id="disconnectBtn" disabled>Disconnect</button>
    </div>

    <div id="status" class="status disconnected">
      Status: Disconnected
    </div>

    <div class="info">
      <label>Agent UUID:</label>
      <span id="uuid">-</span>
    </div>

    <div class="info">
      <label>Running Pods:</label>
      <span id="pods">0</span>
    </div>

    <div class="info">
      <label>CPU:</label>
      <span id="cpu">-</span>
    </div>

    <div class="info">
      <label>Memory:</label>
      <span id="memory">-</span>
    </div>

    <div class="info">
      <label>GPU Support:</label>
      <span id="gpu">-</span>
    </div>
  </div>

  <script type="module">
    import Agent from './src/main.ts';

    let agent = null;
    const statusEl = document.getElementById('status');
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const serverUrlInput = document.getElementById('serverUrl');

    // Helper function to update UI based on connection state
    function updateConnectionState(state) {
      switch (state) {
        case 'connecting':
          statusEl.className = 'status connecting';
          statusEl.textContent = 'Status: Connecting...';
          connectBtn.disabled = true;
          disconnectBtn.disabled = true;
          break;
        case 'connected':
          statusEl.className = 'status connected';
          statusEl.textContent = 'Status: Connected';
          connectBtn.disabled = true;
          disconnectBtn.disabled = false;
          if (agent) {
            const status = agent.getStatus();
            document.getElementById('uuid').textContent = status.uuid;
            // Update resources immediately when connected
            if (status.cpu) {
              const cores = parseInt(status.cpu) / 1000;
              document.getElementById('cpu').textContent = `${cores} cores`;
            }
            if (status.memory) {
              document.getElementById('memory').textContent = status.memory;
            }
            if (status.gpu !== null) {
              document.getElementById('gpu').textContent = status.gpu ? 'Yes (WebGPU)' : 'No';
            }
          }
          break;
        case 'reconnecting':
          statusEl.className = 'status connecting';
          statusEl.textContent = 'Status: Reconnecting...';
          connectBtn.disabled = true;
          disconnectBtn.disabled = false;
          break;
        case 'disconnected':
          statusEl.className = 'status disconnected';
          statusEl.textContent = 'Status: Disconnected';
          connectBtn.disabled = false;
          disconnectBtn.disabled = true;
          document.getElementById('uuid').textContent = '-';
          document.getElementById('pods').textContent = '0';
          document.getElementById('cpu').textContent = '-';
          document.getElementById('memory').textContent = '-';
          document.getElementById('gpu').textContent = '-';
          break;
      }
    }

    connectBtn.addEventListener('click', async () => {
      const serverUrl = serverUrlInput.value;
      // Derive registry URL from server URL by replacing ws:// with http:// and adding /registry
      const registryUrl = serverUrl.replace(/^ws(s)?:\/\//, 'http$1://') + '/registry';

      updateConnectionState('connecting');

      try {
        agent = new Agent(serverUrl, registryUrl);

        // Listen for connection state changes
        agent.onStateChange((state) => {
          updateConnectionState(state);
        });

        await agent.start();

        // Update status periodically for pod count and resources
        const interval = setInterval(() => {
          if (!agent) {
            clearInterval(interval);
            return;
          }
          const status = agent.getStatus();
          // Only update if connected
          if (status.state === 'connected') {
            document.getElementById('pods').textContent = status.runningPods;

            // Update resources from detected values
            if (status.cpu) {
              // Convert millicores to cores (e.g., "4000m" -> "4 cores")
              const cores = parseInt(status.cpu) / 1000;
              document.getElementById('cpu').textContent = `${cores} cores`;
            }
            if (status.memory) {
              // Memory is already in format like "2.1Gi", just display it
              document.getElementById('memory').textContent = status.memory;
            }
            if (status.gpu !== null) {
              document.getElementById('gpu').textContent = status.gpu ? 'Yes (WebGPU)' : 'No';
            }
          }
        }, 1000);

      } catch (err) {
        console.error('Connection failed:', err);
        updateConnectionState('disconnected');
        const errorMessage = err instanceof Error ? err.message : err?.toString() || 'Unknown error';
        statusEl.textContent = `Status: Error - ${errorMessage}`;
      }
    });

    disconnectBtn.addEventListener('click', async () => {
      if (agent) {
        await agent.stop();
        agent = null;
      }
      updateConnectionState('disconnected');
    });

    // Initialize resource display (will be updated when connected)
    document.getElementById('cpu').textContent = '-';
    document.getElementById('memory').textContent = '-';
    document.getElementById('gpu').textContent = '-';
  </script>
</body>
</html>
